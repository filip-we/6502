.import __VIA_2_START__

    PORTB_2         = __VIA_2_START__
    PORTA_2         = __VIA_2_START__ + 1
    DDRB_2          = __VIA_2_START__ + 2
    DDRA_2          = __VIA_2_START__ + 3

    IFR_CA2         = %00000001
    IFR_CA1         = %00000010
    IFR_SR          = %00000100
    IFR_CB2         = %00001000
    IFR_CB1         = %00010000
    IFR_T2          = %00100000
    IFR_T1          = %01000000

setup_via_2:
    lda #$00
    sta DDRA_2
    rts

read_scan_code:
    lda KB_BUFF_WRITE
    tay
    lda PORTA_2             ; Will clear CA1-interrupt
    tax
    lda keymap, x
    sta KB_BUFF, y
    inc KB_BUFF_WRITE
    rts

; Credit to Ben for this nice table
keymap:
  .byte "????????????? `?" ; 00-0F
  .byte "?????q1???zsaw2?" ; 10-1F
  .byte "?cxde43?? vftr5?" ; 20-2F
  .byte "?nbhgy6???mju78?" ; 30-3F
  .byte "?,kio09??./l;p-?" ; 40-4F
  .byte "??'?[=????",$0a,"]?\??" ; 50-5F
  .byte "?????????1?47???" ; 60-6F
  .byte "0.2568",$1b,"??+3-*9??" ; 70-7F
  .byte "????????????????" ; 80-8F
  .byte "????????????????" ; 90-9F
  .byte "????????????????" ; A0-AF
  .byte "????????????????" ; B0-BF
  .byte "????????????????" ; C0-CF
  .byte "????????????????" ; D0-DF
  .byte "????????????????" ; E0-EF
  .byte "????????????????" ; F0-FF
